#!/usr/bin/env ruby
#
# Transforms the existing mirror
#

require 'fileutils'
require 'json'
require 'rubygems/package'
require 'yaml'

Dir[File.expand_path('../mirror/gems/*.gem', __FILE__)].sort.each do |gem_path|
  #gem_name = File.basename(gem_path, '.gem')
  spec = Gem::Package.new(gem_path).spec rescue nil
  unless spec
    # ignore broken gems
    next
  end

  postfix = spec.platform == "ruby" ? "" : "-#{spec.platform}"
  nix_path =
    "gems/#{spec.name[0]}/#{spec.name}/#{spec.version}#{postfix}.json"
  if File.exist? nix_path
    # already done
    next
  end

  gem_hash = `nix-hash --base32 --type sha256 "#{gem_path}"`.strip

  nix = {
    sha256: gem_hash,

    meta: {
      description: spec.description,
      homepage: spec.homepage,
      license: spec.license,
    }
  }

  FileUtils.mkdir_p File.dirname(nix_path)
  File.write(nix_path, JSON.pretty_generate(nix))

  puts nix_path
end
